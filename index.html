
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Bosquejo - Studio Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004a99">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sermones MMM">
    <link rel="apple-touch-icon" href="logo.png">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { 
            --azul-mmm: #004a99; 
            --amarillo-mmm: #f1c40f;
        }
        
        /* Colores de herramientas */
        .side-tab, #hammer-icon { 
            background-color: var(--azul-mmm) !important; 
            color: var(--amarillo-mmm) !important;
            border: 1px solid var(--amarillo-mmm);
        }
        .btn-success { background-color: #27ae60 !important; }

        /* NUEVOS ESTILOS INTEGRADOS */
        .btn-preview { background-color: #f39c12 !important; color: white !important; }
        .btn-bible { background-color: #34495e !important; color: white !important; }
        
        #pdf-loader {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--azul-mmm);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-family: sans-serif;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid var(--amarillo-mmm);
        }

        /* Estilo para los selects del ala izquierda */
        .sidebar-select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 2px solid var(--azul-mmm);
            font-weight: bold;
            color: var(--azul-mmm);
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        #watermark img, .mini-logo {
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            background: transparent !important;
        }

        .btn-history {
            font-size: 1.2rem;
            color: #2c3e50;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        
        #inputImport { display: none; }

        #paper {
            padding: 40px 20px !important;
            margin: 10px auto !important;
            width: 95% !important;
            max-width: 800px;
        }
    </style>
</head>
<body>

    <div id="pdf-loader">Procesando documento...</div>

    <div id="floating-toolbar">
        <div class="side-tab left-tab" onclick="toggleRibbon('left')">üñãÔ∏è</div>
        <div id="left-ribbon" class="ribbon hidden">
            <div class="scroll-container">
                
                <select id="sermon-selector" class="sidebar-select" onchange="handleSermonSelect(this)">
                    </select>

                <div class="divider"></div>

                <button type="button" class="btn-history" title="Deshacer" onmousedown="historyUndo(event)">‚ü≤</button>
                <button type="button" class="btn-history" title="Rehacer" onmousedown="historyRedo(event)">‚ü≥</button>
                
                <div class="divider"></div>
                
                <button type="button" id="btn-bold" onmousedown="execCmd('bold', event)"><b>B</b></button>
                <button type="button" id="btn-italic" onmousedown="execCmd('italic', event)"><i>I</i></button>
                <button type="button" id="btn-underline" onmousedown="execCmd('underline', event)"><u>U</u></button>
                
                <div class="divider"></div>
                
                <div class="color-picker-container">
                    <input type="color" id="fontColor" oninput="execCmd('foreColor', event, this.value)" title="Color de letra">
                </div>
                
                <div class="divider"></div>
                
                <select onchange="handleStudySelect(this)" class="sidebar-select">
                    <option value="">üìö Estudio</option>
                    <option value="https://bible.com/bible">üìñ Biblia (YouVersion)</option>
                    <option value="notas.html">üìù Mis Notas</option>
                    <option value="glosario.html">üìñ Glosario T√©cnico</option>
                    <option value="vers√≠culos.html">üìë Mis Vers√≠culos</option>
                    <option value="EXPORT">üíæ Guardar Backup (Mes)</option>
                    <option value="IMPORT">üìÇ Restaurar Backup</option>
                    <option value="https://diccionariobiblico.net/">üìñ Diccionario B√≠blico</option>
                </select>
                <input type="file" id="inputImport" accept=".json" onchange="importarDatosMes(event)">
            </div>
        </div>

        <div id="hammer-icon">üî®</div>

        <div id="right-ribbon" class="ribbon hidden">
            <div class="scroll-container">
                <button onclick="addSection('Texto B√≠blico', '#f1c40f')">üìñ Texto</button>
                <button onclick="addSection('Tema / T√≠tulo', '#3498db')">üè∑Ô∏è Tema</button>
                <select onchange="addPurpose(this.value); this.value='';" class="purpose-select">
                    <option value="">üéØ Prop√≥sito</option>
                    <option value="Evangel√≠stico">Evangel√≠stico</option>
                    <option value="Aliento (Consuelo)">Aliento</option>
                    <option value="Doctrinal (Did√°ctico)">Doctrinal</option>
                    <option value="Devocional">Devocional</option>
                    <option value="Consagraci√≥n">Consagraci√≥n</option>
                </select>
                <button onclick="addSection('Introducci√≥n', '#34495e')">üé§ Intro</button>
                <button onclick="addMainPoint()">‚Ö† Punto</button>
                <button onclick="addSubPoint()">‚í∂ Sub</button>
                <button onclick="addSection('Conclusi√≥n', '#e74c3c')">üèÅ Conclusi√≥n</button>
                <button onclick="addSection('Glosario Final', '#16a085')">üìö Glosario</button>
                <div class="divider"></div>
                <button onclick="previewPDF()" class="btn-preview">üëÅÔ∏è Vista</button>
                <button onclick="generatePDF()" class="btn-success">PDF</button>
                <button onclick="clearData()" class="btn-danger">üóëÔ∏è Limpiar</button>
            </div>
        </div>
        <div class="side-tab right-tab" onclick="toggleRibbon('right')">üìã</div>
    </div>
    
    <div id="document-area">
        <div id="paper">
            <div id="watermark">
                <img src="logo.png" alt="Logo">
            </div>
            <h1 contenteditable="true" id="main-title" class="placeholder" data-placeholder="T√çTULO DEL SERM√ìN" oninput="saveCurrentWork()"></h1>
            <div id="sections-container"></div>
            <footer id="sermon-footer">
                <div class="footer-content">
                    <p class="verse">"Tu palabra es una l√°mpara a mis pies y una luz en mi camino."</p>
                    <p class="reference">Salmo 119:105</p>
                    <div class="brand">
                        <img src="logo.png" alt="Logo" class="mini-logo">
                        <span>Studio Edition 2025</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // REGISTRO DEL SERVICE WORKER (Necesario para que el manifest funcione)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('Service Worker registrado', reg);
                }).catch(err => {
                    console.log('Error al registrar Service Worker', err);
                });
            });
        }

        let allSermons = JSON.parse(localStorage.getItem('mmm_sermon_collection')) || { "Principal": { title: "", content: "" } };
        let activeSermonId = localStorage.getItem('mmm_active_id') || "Principal";

        function handleSermonSelect(select) {
            const val = select.value;
            if (!val) return;

            if (val === "NEW_SERMON") {
                const name = prompt("Nombre del nuevo bosquejo:");
                if (name && !allSermons[name]) {
                    allSermons[name] = { title: "", content: "" };
                    activeSermonId = name;
                    saveToStorage(); loadSermon(); updateSermonList();
                }
            } else if (val === "DELETE_ACTIVE") {
                if (confirm(`¬øBorrar definitivamente "${activeSermonId}"?`)) {
                    delete allSermons[activeSermonId];
                    activeSermonId = Object.keys(allSermons)[0] || "Principal";
                    if (!allSermons["Principal"]) allSermons["Principal"] = { title: "", content: "" };
                    saveToStorage(); loadSermon(); updateSermonList();
                }
            } else {
                saveCurrentWork();
                activeSermonId = val;
                localStorage.setItem('mmm_active_id', val);
                loadSermon();
            }
        }

        function updateSermonList() {
            const selector = document.getElementById('sermon-selector');
            selector.innerHTML = `<option value="">üìÇ Cambiar Bosquejo</option>`;
            selector.innerHTML += `<option value="NEW_SERMON">‚ûï Crear Nuevo...</option>`;
            selector.innerHTML += `<option value="DELETE_ACTIVE">‚ùå Borrar Actual</option>`;
            selector.innerHTML += `<hr>`;

            for (let id in allSermons) {
                let opt = document.createElement('option');
                opt.value = id;
                opt.innerText = (id === activeSermonId ? "üìç " : "üìÑ ") + id;
                if (id === activeSermonId) opt.selected = true;
                selector.appendChild(opt);
            }
        }

        function loadSermon() {
            const data = allSermons[activeSermonId];
            document.getElementById('main-title').innerText = data.title || "";
            document.getElementById('sections-container').innerHTML = data.content || "";
            if (typeof saveData === "function") saveData();
        }

        function saveCurrentWork() {
            allSermons[activeSermonId].title = document.getElementById('main-title').innerText;
            allSermons[activeSermonId].content = document.getElementById('sections-container').innerHTML;
            saveToStorage();
            if (typeof saveData === "function") saveData();
        }

        document.getElementById('sections-container').addEventListener('input', saveCurrentWork);
        document.getElementById('main-title').addEventListener('input', saveCurrentWork);

        function saveToStorage() {
            localStorage.setItem('mmm_sermon_collection', JSON.stringify(allSermons));
            localStorage.setItem('mmm_active_id', activeSermonId);
        }

        function handleStudySelect(select) {
            const val = select.value;
            if (!val) return;
            if (val === "EXPORT") exportarDatosMes();
            else if (val === "IMPORT") document.getElementById('inputImport').click();
            else if (val.includes('http')) window.open(val, '_blank');
            else window.location.href = val;
            select.value = "";
        }

        function exportarDatosMes() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allSermons));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `Backup_Sermones_MMM.json`);
            dlAnchor.click();
        }

        function importarDatosMes(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    allSermons = JSON.parse(e.target.result);
                    activeSermonId = Object.keys(allSermons)[0];
                    saveToStorage(); loadSermon(); updateSermonList();
                    alert("Importaci√≥n exitosa.");
                } catch(err) { alert("Archivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        // Funciones auxiliares para el feedback visual del PDF
        function showLoading(show) {
            document.getElementById('pdf-loader').style.display = show ? 'block' : 'none';
        }

        window.onload = () => { updateSermonList(); loadSermon(); };
    </script>
</body>
</html>
