<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMM Studio Pro - Iv√°n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-red: #ef4444; --primary-blue: #3b82f6; --bg: #f8fafc;
            --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --accent-yellow: #facc15;
        }
        [data-theme="dark"] {
            --bg: #020617; --card: #1e293b; --text: #f8fafc; --border: #334155;
        }

        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.4s; overflow: hidden; height: 100vh; }

        .drag-box { position: fixed; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; touch-action: none; }
        #drag-wrapper { top: 80px; right: 20px; }
        #tele-drag { top: 20px; left: 20px; display: none; }

        .tele-collapsed .btn-mini:not(.btn-toggle-tele) { display: none; }

        .fab-round {
            width: 60px; height: 60px; background: var(--primary-blue); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); cursor: move; border: 2px solid var(--accent-yellow); font-size: 1.5rem;
        }

        .btn-mini {
            width: 45px; height: 45px; background: var(--primary-blue); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-bottom: 8px; border: 2px solid white; font-size: 1rem; cursor: pointer; font-weight: bold;
            touch-action: auto;
        }

        .drawer-content {
            width: 280px; max-height: 400px; background: var(--card); border-radius: 20px;
            margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none;
            flex-direction: column; overflow: hidden; border: 1px solid var(--border);
        }
        .drawer-content.open { display: flex; }
        .drawer-header { padding: 12px; background: var(--primary-blue); color: white; font-weight: 800; text-align: center; font-size: 0.9rem; }
        #monthContainer { flex: 1; overflow-y: auto; padding: 10px; max-height: 340px; }

        .month-chip {
            background: var(--bg); padding: 12px; border-radius: 14px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            border: 2px solid transparent; font-weight: 600; font-size: 0.85rem;
        }
        .month-chip.active { border-color: var(--primary-blue); background: rgba(59, 130, 246, 0.1); }
        .btn-del { color: var(--primary-red); font-size: 1.1rem; cursor: pointer; background: none; border: none; }

        .navbar { background: var(--card); padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .container { max-width: 850px; margin: auto; padding: 15px; height: calc(100vh - 70px); display: flex; flex-direction: column; }

        .mini-upload {
            border: 2px dashed var(--primary-blue); border-radius: 15px; padding: 12px;
            text-align: center; position: relative; background: rgba(59, 130, 246, 0.03);
            margin-bottom: 10px; font-size: 0.85rem; font-weight: 700;
        }
        #pdfInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        #progress-container {
            width: 100%; height: 12px; background: var(--border); border-radius: 10px;
            margin-bottom: 10px; display: none; overflow: hidden;
        }
        #progress-bar { width: 0%; height: 100%; background: var(--primary-blue); transition: width 0.3s ease; }

        #output { 
            flex: 1; background: var(--card); border-radius: 20px; padding: 20px;
            border: 1px solid var(--border); overflow-y: auto; outline: none;
            line-height: 1.8; font-size: 1.1rem; box-sizing: border-box; margin-bottom: 10px;
        }

        .text-red { color: var(--primary-red); font-weight: 800; font-size: 1.3rem; display: block; margin-top: 20px; }
        .text-blue { color: var(--primary-blue); font-weight: 700; font-size: 1.15rem; display: block; margin-top: 10px; }

        .actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-action { padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; color: white; font-size: 0.8rem; }

        .tele-view {
            position: fixed; inset: 0; background: #000; color: #fff; z-index: 1500;
            display: none; flex-direction: column; padding: 40px; text-align: center;
            touch-action: pan-y; /* Permite scroll manual */
        }
        #tele-content { 
            font-size: 2.8rem; font-weight: 800; overflow-y: auto; 
            scroll-behavior: auto; height: 100%; 
        }
        #tele-content::-webkit-scrollbar { display: none; }

        @media (max-width: 600px) { .actions-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

<div id="drag-wrapper" class="drag-box">
    <div class="btn-mini" onclick="irABosquejos()" title="Ir a Bosquejos">üîó</div>
    <button class="fab-round" id="fabBtn">üìÖ</button>
    <div id="drawer" class="drawer-content">
        <div class="drawer-header">HISTORIAL DE MESES</div>
        <div id="monthContainer"></div>
    </div>
</div>

<div id="tele-drag" class="drag-box">
    <div class="btn-mini btn-toggle-tele" onclick="toggleTeleButtons()" title="Colapsar/Expandir">‚ûñ</div>
    <div class="btn-mini" onclick="closeTele()">üîô</div>
    <div class="btn-mini" onclick="toggleAutoScroll()" id="scrollBtn">‚ñ∂Ô∏è</div>
    <div class="btn-mini" onclick="updateScrollSpeed(-8)" title="M√°s R√°pido">‚ö°+</div>
    <div class="btn-mini" onclick="updateScrollSpeed(8)" title="M√°s Lento">üê¢-</div>
    <div class="btn-mini" onclick="changeFontSize(2)">A‚ûï</div>
    <div class="btn-mini" onclick="changeFontSize(-2)">A‚ûñ</div>
</div>

<div id="tele" class="tele-view">
    <div id="tele-content"></div>
</div>

<nav class="navbar">
    <h2 style="margin:0; font-weight:800; color:var(--primary-blue); font-size: 1.2rem;">MMM STUDIO PRO</h2>
    <button class="btn-action" style="background:var(--border); color:var(--text); padding:8px 15px" onclick="toggleTheme()">üåì</button>
</nav>

<div class="container">
    <div class="mini-upload">
        <span id="fileInfo">üìÅ SUBIR PDF</span>
        <input type="file" id="pdfInput" accept="application/pdf">
    </div>

    <button onclick="processPDF()" class="btn-action" style="background:var(--primary-blue); width:100%; margin-bottom:10px; font-size:1rem; padding: 15px;">‚ö° ESCANEAR Y LIMPIAR</button>
    
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>
    
    <div id="loader" style="display:none; text-align:center; font-weight:bold; color:var(--primary-blue); margin-bottom:10px;">üöÄ Procesando... <span id="percent">0%</span></div>

    <div id="output" contenteditable="true"></div>

    <div class="actions-grid">
        <button onclick="copyWA()" class="btn-action" style="background:#25d366">WHATSAPP</button>
        <button onclick="openTele()" class="btn-action" style="background:#6366f1">TELEPROMPTER</button>
        <button onclick="downloadDoc()" class="btn-action" style="background:#2b579a">WORD</button>
        <button onclick="downloadPDF()" class="btn-action" style="background:#ef4444">PDF</button>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    let db = JSON.parse(localStorage.getItem('MMM_DRAG_V6') || '{}');
    let activeKey = "";
    let scrollInterval, isScrolling = false, tFontSize = 45;
    let scrollSpeed = 40; 

    window.onload = refreshUI;

    function irABosquejos() {
        window.location.href = "https://rmns82839-rgb.github.io/bosquejo2.0";
    }

    function toggleTeleButtons() {
        const teleDrag = document.getElementById('tele-drag');
        const btnToggle = document.querySelector('.btn-toggle-tele');
        teleDrag.classList.toggle('tele-collapsed');
        btnToggle.innerText = teleDrag.classList.contains('tele-collapsed') ? "‚ûï" : "‚ûñ";
    }

    function makeMagnetic(elId) {
        const el = document.getElementById(elId);
        let currX = 0, currY = 0, startX, startY, active = false;
        
        el.addEventListener('touchstart', s, {passive: false}); 
        el.addEventListener('mousedown', s);
        window.addEventListener('touchmove', m, {passive: false}); 
        window.addEventListener('mousemove', m);
        window.addEventListener('touchend', end); 
        window.addEventListener('mouseup', end);

        function s(e) {
            if (e.target.closest('#monthContainer') || e.target.classList.contains('btn-mini')) return;
            active = true;
            startX = (e.type === "touchstart" ? e.touches[0].clientX : e.clientX) - currX;
            startY = (e.type === "touchstart" ? e.touches[0].clientY : e.clientY) - currY;
        }
        function m(e) {
            if (!active) return;
            e.preventDefault();
            currX = (e.type === "touchmove" ? e.touches[0].clientX : e.clientX) - startX;
            currY = (e.type === "touchmove" ? e.touches[0].clientY : e.clientY) - startY;
            el.style.transform = `translate3d(${currX}px, ${currY}px, 0)`;
        }
        function end() {
            if (!active) return;
            active = false;
            el.style.transition = "transform 0.4s cubic-bezier(0.17, 0.67, 0.41, 1.21)";
            const r = el.getBoundingClientRect();
            const d = { t: r.top, b: window.innerHeight - r.bottom, l: r.left, r: window.innerWidth - r.right };
            const min = Math.min(d.t, d.b, d.l, d.r);
            if (min === d.t) currY = 15 - el.offsetTop;
            else if (min === d.b) currY = (window.innerHeight - el.offsetHeight - 15) - el.offsetTop;
            else if (min === d.l) currX = 15 - el.offsetLeft;
            else currX = (window.innerWidth - el.offsetWidth - 15) - el.offsetLeft;
            el.style.transform = `translate3d(${currX}px, ${currY}px, 0)`;
            setTimeout(() => el.style.transition = "none", 400);
        }
    }

    makeMagnetic('drag-wrapper');
    makeMagnetic('tele-drag');

    document.getElementById('pdfInput').onchange = (e) => { 
        if(e.target.files[0]) document.getElementById('fileInfo').innerText = "‚úÖ " + e.target.files[0].name;
    };

    function cleanText(text) {
        return text
            .replace(/\?=e+o+/gi, '')
            .replace(/-\s*CEO\s*-+/gi, '')
            .replace(/[-_]{2,}/g, ' ')
            .replace(/\.{4,}/g, '...')
            .replace(/\s{2,}/g, ' ')
            .replace(/[|¬¶]/g, ' ')
            .replace(/[^\x20-\x7E\xA1-\xFF\n]/g, '')
            .replace(/P√°gina \d+ de \d+/gi, '')
            .replace(/^\s*-\s*$/gm, '')
            .trim();
    }

    function formatHTML(text) {
        if(!text) return "";
        return text.split('\n').map(l => {
            const line = l.trim();
            if (!line) return '<br>';
            if (/PUEDE REVIVIR|REALIZADO POR|IV√ÅN|TEMA/i.test(line)) return `<span class="text-red">${line}</span>`;
            if (/TEXTO|PROP√ìSITO|INTRODUCCI√ìN|PUNTO|LUCAS|JOB|SALMOS|JUAN|MATEO|MARCOS|HECHOS/i.test(line)) return `<span class="text-blue">${line}</span>`;
            return `<span>${line}</span>`;
        }).join('<br>');
    }

    function refreshUI() {
        const container = document.getElementById('monthContainer');
        container.innerHTML = "";
        Object.keys(db).sort().forEach(key => {
            const div = document.createElement('div');
            div.className = `month-chip ${activeKey === key ? 'active' : ''}`;
            div.innerHTML = `<span style="flex:1" onclick="selectMonth('${key}')">${key}</span>
                             <button class="btn-del" onclick="delMonth(event, '${key}')">üóëÔ∏è</button>`;
            container.appendChild(div);
        });
        localStorage.setItem('MMM_DRAG_V6', JSON.stringify(db));
    }

    function selectMonth(key) {
        activeKey = key; document.getElementById('output').innerHTML = formatHTML(db[key]);
        document.getElementById('drawer').classList.remove('open'); refreshUI();
    }

    async function processPDF() {
        const file = document.getElementById('pdfInput').files[0];
        if(!file) return alert("Sube un PDF");
        const nombre = prompt("Nombre del Mes:", "Diciembre");
        if(!nombre) return;
        const loader = document.getElementById('loader');
        const progContainer = document.getElementById('progress-container');
        const progBar = document.getElementById('progress-bar');
        loader.style.display = "block"; progContainer.style.display = "block";
        let full = "";
        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const percent = Math.round((i/pdf.numPages)*100);
            document.getElementById('percent').innerText = percent + "%"; progBar.style.width = percent + "%";
            const page = await pdf.getPage(i);
            const canvas = document.createElement('canvas');
            const vp = page.getViewport({ scale: 2.2 });
            canvas.height = vp.height; canvas.width = vp.width;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
            const { data: { text } } = await Tesseract.recognize(canvas, 'spa');
            full += text + "\n";
        }
        db[nombre] = cleanText(full); refreshUI(); selectMonth(nombre);
        loader.style.display = "none"; progContainer.style.display = "none";
    }

    function downloadDoc() {
        const text = document.getElementById('output').innerText;
        if(!text) return alert("No hay texto");
        const doc = new docx.Document({
            sections: [{ children: text.split('\n').map(l => new docx.Paragraph({ text: l.trim() })) }]
        });
        docx.Packer.toBlob(doc).then(blob => saveAs(blob, `Bosquejo_${activeKey || 'MMM'}.docx`));
    }

    function downloadPDF() {
        const text = document.getElementById('output').innerText;
        if(!text) return alert("No hay texto");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(11);
        const lines = doc.splitTextToSize(text, 180);
        doc.text(lines, 15, 20);
        doc.save(`Bosquejo_${activeKey || 'MMM'}.pdf`);
    }

    function openTele() {
        const content = document.getElementById('output').innerHTML;
        if(!content) return alert("No hay texto");
        document.getElementById('tele-content').innerHTML = content;
        document.getElementById('tele').style.display = "flex";
        document.getElementById('tele-drag').style.display = "flex";
        document.getElementById('drag-wrapper').style.display = "none";
    }

    function closeTele() {
        document.getElementById('tele').style.display = "none";
        document.getElementById('tele-drag').style.display = "none";
        document.getElementById('drag-wrapper').style.display = "flex";
        clearInterval(scrollInterval); isScrolling = false;
        document.getElementById('scrollBtn').innerText = "‚ñ∂Ô∏è";
    }

    function toggleAutoScroll() {
        if(isScrolling) { 
            clearInterval(scrollInterval); 
            document.getElementById('scrollBtn').innerText = "‚ñ∂Ô∏è"; 
        } else { 
            startScroll();
            document.getElementById('scrollBtn').innerText = "‚è∏Ô∏è"; 
        }
        isScrolling = !isScrolling;
    }

    function startScroll() {
        clearInterval(scrollInterval);
        const box = document.getElementById('tele-content');
        scrollInterval = setInterval(() => { 
            box.scrollTop += 1; 
        }, scrollSpeed);
    }

    function updateScrollSpeed(delta) {
        scrollSpeed += delta;
        if (scrollSpeed < 5) scrollSpeed = 5; 
        if (scrollSpeed > 150) scrollSpeed = 150; 
        if (isScrolling) startScroll(); 
    }

    function changeFontSize(v) { tFontSize += v; document.getElementById('tele-content').style.fontSize = tFontSize + "px"; }
    document.getElementById('fabBtn').onclick = () => document.getElementById('drawer').classList.toggle('open');
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function copyWA() { navigator.clipboard.writeText(document.getElementById('output').innerText); alert("¬°Copiado!"); }
    function delMonth(e, k) { e.stopPropagation(); if(confirm("Borrar?")) { delete db[k]; refreshUI(); document.getElementById('output').innerHTML = ""; } }
</script>
</body>
  </html>
