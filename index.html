<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Bosquejo - Studio Edition</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Ajuste especÃ­fico para el logo solicitado */
        #watermark img, .mini-logo {
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            background: transparent !important;
        }
        /* Estilo para los nuevos botones de deshacer/rehacer */
        .btn-history {
            font-size: 1.2rem;
            color: #2c3e50;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            transition: 0.2s;
        }
        .btn-history:active { transform: scale(0.8); }

        /* Estilo para el input de importaciÃ³n oculto */
        #inputImport { display: none; }
    </style>
</head>
<body>
    <div id="floating-toolbar">
        <div class="side-tab left-tab" onclick="toggleRibbon('left')">ğŸ–‹ï¸</div>
        
        <div id="left-ribbon" class="ribbon hidden">
            <div class="scroll-container">
                <button type="button" class="btn-history" title="Deshacer" onmousedown="historyUndo(event)">âŸ²</button>
                <button type="button" class="btn-history" title="Rehacer" onmousedown="historyRedo(event)">âŸ³</button>
                
                <div class="divider"></div>

                <button type="button" id="btn-bold" onmousedown="execCmd('bold', event)"><b>B</b></button>
                <button type="button" id="btn-italic" onmousedown="execCmd('italic', event)"><i>I</i></button>
                <button type="button" id="btn-underline" onmousedown="execCmd('underline', event)"><u>U</u></button>
                
                <div class="divider"></div>
                
                <div class="color-picker-container">
                    <input type="color" id="fontColor" oninput="execCmd('foreColor', event, this.value)" title="Color de letra">
                </div>

                <div class="divider"></div>

                <select onchange="handleStudySelect(this)" class="study-select">
                    <option value="">ğŸ“š Estudio</option>
                    <option value="notas.html">ğŸ“ Mis Notas</option>
                    <option value="glosario.html">ğŸ“– Glosario TÃ©cnico</option>
                    <option value="versÃ­culos.html">ğŸ“‘ Mis VersÃ­culos</option>
                    <option value="EXPORT">ğŸ’¾ Guardar Backup (Mes)</option>
                    <option value="IMPORT">ğŸ“‚ Restaurar Backup</option>
                    <option value="https://diccionariobiblico.net/">ğŸ“– Diccionario BÃ­blico</option>
                    <option value="https://www.blueletterbible.org/">Blue Letter</option>
                    <option value="https://www.biblegateway.com/">Bible Gateway</option>
                </select>
                <input type="file" id="inputImport" accept=".json" onchange="importarDatosMes(event)">
            </div>
        </div>

        <div id="hammer-icon">ğŸ”¨</div>

        <div id="right-ribbon" class="ribbon hidden">
            <div class="scroll-container">
                <button onclick="addSection('Texto BÃ­blico', '#f1c40f')">ğŸ“– Texto</button>
                <button onclick="addSection('Tema / TÃ­tulo', '#3498db')">ğŸ·ï¸ Tema</button>
                
                <select onchange="addPurpose(this.value); this.value='';" class="purpose-select">
                    <option value="">ğŸ¯ Elegir PropÃ³sito</option>
                    <option value="EvangelÃ­stico">EvangelÃ­stico</option>
                    <option value="Aliento (Consuelo)">Aliento (Consuelo)</option>
                    <option value="Doctrinal (DidÃ¡ctico)">Doctrinal (DidÃ¡ctico)</option>
                    <option value="Devocional">Devocional</option>
                    <option value="ConsagraciÃ³n">ConsagraciÃ³n</option>
                    <option value="Ã‰tico-Moral">Ã‰tico-Moral</option>
                </select>

                <button onclick="addSection('IntroducciÃ³n', '#34495e')">ğŸ¤ Intro</button>
                <button onclick="addMainPoint()">â…  Punto</button>
                <button onclick="addSubPoint()">â’¶ Sub</button>
                <button onclick="addSection('ConclusiÃ³n', '#e74c3c')">ğŸ ConclusiÃ³n</button>
                <button onclick="addSection('Glosario Final', '#16a085')">ğŸ“š Glosario Final</button>

                <div class="divider"></div>

                <button onclick="generatePDF()" class="btn-success">PDF</button>
                <button onclick="clearData()" class="btn-danger">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="side-tab right-tab" onclick="toggleRibbon('right')">ğŸ“‹</div>
    </div>

    <div id="document-area">
        <div id="paper">
            <div id="watermark">
                <img src="logo.png" alt="Logo">
            </div>

            <h1 contenteditable="true" id="main-title" class="placeholder" data-placeholder="TÃTULO DEL SERMÃ“N" oninput="saveData()"></h1>
            
            <div id="sections-container"></div>

            <footer id="sermon-footer">
                <div class="footer-content">
                    <p class="verse">"Tu palabra es una lÃ¡mpara a mis pies y una luz en mi camino."</p>
                    <p class="reference">Salmo 119:105</p>
                    <div class="brand">
                        <img src="logo.png" alt="Logo" class="mini-logo">
                        <span>Studio Edition 2025</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // LÃ³gica para manejar las opciones especiales del menÃº de estudio
        function handleStudySelect(select) {
            const val = select.value;
            if (!val) return;

            if (val === "EXPORT") {
                exportarDatosMes();
            } else if (val === "IMPORT") {
                document.getElementById('inputImport').click();
            } else if (val.includes('http')) {
                window.open(val, '_blank');
            } else {
                window.location.href = val;
            }
            select.value = ""; // Resetear select
        }

        // FunciÃ³n para exportar el bosquejo actual (Backup mensual)
        function exportarDatosMes() {
            const titulo = document.getElementById('main-title').innerText || 'bosquejo';
            const datos = {
                titulo: titulo,
                contenido: document.getElementById('sections-container').innerHTML,
                fecha: new Date().toLocaleDateString()
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(datos));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `Bosquejo_${titulo.replace(/\s+/g, '_')}.json`);
            dlAnchor.click();
        }

        // FunciÃ³n para restaurar un bosquejo guardado
        function importarDatosMes(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm("Â¿Restaurar este bosquejo? Se perderÃ¡ lo que no hayas guardado.")) {
                        document.getElementById('main-title').innerText = data.titulo || "";
                        document.getElementById('sections-container').innerHTML = data.contenido || "";
                        // Llamar a saveData() si existe en tu script.js para que persista en el navegador
                        if (typeof saveData === "function") saveData();
                        alert("Â¡Bosquejo restaurado con Ã©xito!");
                    }
                } catch (err) {
                    alert("Error: El archivo no es vÃ¡lido.");
                }
            };
            reader.readAsText(file);
        }

        // Registro de Service Worker para App
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
        }
    </script>
</body>
</html>
