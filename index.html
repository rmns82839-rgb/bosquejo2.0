<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Bosquejo - Studio Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004a99">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sermones MMM">
    <link rel="apple-touch-icon" href="logo.png">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { 
            --azul-mmm: #004a99; 
            --amarillo-mmm: #f1c40f;
        }
        
        .side-tab, #hammer-icon { 
            background-color: var(--azul-mmm) !important; 
            color: var(--amarillo-mmm) !important;
            border: 1px solid var(--amarillo-mmm);
        }
        .btn-success { background-color: #27ae60 !important; }
        .btn-preview { background-color: #f39c12 !important; color: white !important; }
        .btn-bible { background-color: #34495e !important; color: white !important; }
        
        #pdf-loader {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--azul-mmm);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-family: sans-serif;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid var(--amarillo-mmm);
        }
        .sidebar-select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 2px solid var(--azul-mmm);
            font-weight: bold;
            color: var(--azul-mmm);
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }
        #watermark img, .mini-logo {
            border: none !important;
            box-shadow: none !important;
            outline: none !important;
            background: transparent !important;
        }
        .btn-history {
            font-size: 1.2rem;
            color: #2c3e50;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        
        #inputImport { display: none; }
        #paper {
            padding: 40px 20px !important;
            margin: 10px auto !important;
            width: 95% !important;
            max-width: 800px;
            background-color: white;
        }

        /* MEJORA: Estilo para el autor con Placeholder */
        #author-container {
            margin-top: 10px;
            color: #555;
            display: none; 
            font-size: 1.1rem;
        }
        .author-label { font-weight: bold; color: var(--azul-mmm); }
        
        /* Efecto Placeholder para el autor */
        #author-name:empty:before {
            content: attr(data-placeholder);
            color: #aaa;
            font-style: italic;
            cursor: text;
        }

        /* BARRA DE PROGRESO STUDIO */
        #page-progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #e2e8f0;
            z-index: 10000;
        }
        #page-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width 0.3s ease;
        }
        #page-progress-text {
            position: fixed;
            top: 8px;
            right: 20px;
            font-size: 10px;
            font-weight: bold;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>

</head>
<body>

    <div id="page-progress-container" class="no-print">
        <div id="page-progress-bar"></div>
        <span id="page-progress-text">Espacio: 0%</span>
    </div>

    <div id="pdf-loader">Generando PDF seleccionable...</div>
    
    <div id="floating-toolbar">
        <div class="side-tab left-tab" onclick="toggleRibbon('left')">üñãÔ∏è</div>
        
        <div id="left-ribbon" class="ribbon hidden">
            <div class="scroll-container">
                <select id="sermon-selector" class="sidebar-select" onchange="handleSermonSelect(this)"></select>
                <div class="divider"></div>
                <button type="button" class="btn-history" title="Deshacer" onmousedown="historyUndo(event)">‚ü≤</button>
                <button type="button" class="btn-history" title="Rehacer" onmousedown="historyRedo(event)">‚ü≥</button>
                <div class="divider"></div>
                <button type="button" id="btn-bold" onmousedown="execCmd('bold', event)"><b>B</b></button>
                <button type="button" id="btn-italic" onmousedown="execCmd('italic', event)"><i>I</i></button>
                <button type="button" id="btn-underline" onmousedown="execCmd('underline', event)"><u>U</u></button>
                
                <button type="button" id="btn-highlight" onmousedown="execCmd('hiliteColor', event, '#ffffb0')">üñçÔ∏è</button>
                <div class="divider"></div>
                <div class="color-picker-container">
                    <input type="color" id="fontColor" oninput="execCmd('foreColor', event, this.value)" title="Color de letra">
                </div>
                <div class="divider"></div>
                <select onchange="handleStudySelect(this)" class="sidebar-select">
                    <option value="">üìö Estudio</option>
                    <option value="https://bible.com/bible">üìñ Biblia (YouVersion)</option>
                    <option value="notas.html">üìù Mis Notas</option>
                    <option value="glosario.html">üìñ Glosario T√©cnico</option>
                    <option value="vers√≠culos.html">üìë Mis Vers√≠culos</option>
                    <option value="EXPORT">üíæ Guardar Backup (Mes)</option>
                    <option value="IMPORT">üìÇ Restaurar Backup</option>
                    <option value="https://diccionariobiblico.net/">üìñ Diccionario B√≠blico</option>
                </select>
                <input type="file" id="inputImport" accept=".json" onchange="importarDatosMes(event)">
            </div>
        </div>

        <div id="hammer-icon">üî®</div>

        <div id="right-ribbon" class="ribbon hidden">
            <div class="scroll-container">
                <button onclick="addSection('Texto B√≠blico', '#f1c40f')">üìñ Texto</button>
                <button onclick="addSection('Tema / T√≠tulo', '#3498db')">üè∑Ô∏è Tema</button>
                <button onclick="toggleAuthorField()">üë§ Autor</button> 
                <button onclick="addScripture()" style="border: 1.5px solid #3b82f6;">üìñ Cita</button>
                <select onchange="addPurpose(this.value); this.value='';" class="purpose-select">
                    <option value="">üéØ Prop√≥sito</option>
                    <option value="Evangel√≠stico">Evangel√≠stico</option>
                    <option value="Aliento (Consuelo)">Aliento</option>
                    <option value="Doctrinal (Did√°ctico)">Doctrinal</option>
                    <option value="Devocional">Devocional</option>
                    <option value="Consagraci√≥n">Consagraci√≥n</option>
                </select>
                <button onclick="addSection('Introducci√≥n', '#34495e')">üé§ Intro</button>
                <button onclick="addMainPoint()">‚Ö† Punto</button>
                <button onclick="addSubPoint()">‚í∂ Sub</button>
                <button onclick="addPageBreak()" style="background: #f1f5f9; border: 1px dashed #3b82f6;">‚úÇÔ∏è Salto Hoja</button>
                <button onclick="addSection('Conclusi√≥n', '#e74c3c')">üèÅ Conclusi√≥n</button>
                <button onclick="addSection('Glosario Final', '#16a085')">üìö Glosario</button>
                <div class="divider"></div>
                <button onclick="previewPDF()" class="btn-preview">üëÅÔ∏è Vista</button>
                <button onclick="generatePDF()" class="btn-success">PDF</button>
                <button onclick="toggleDarkMode()" id="btn-dark-mode" title="Modo Noche">
    üåô
</button>

<button onclick="clearFormatting(event)" title="Limpiar Formato">
    üßπ Borrar Estilos
</button>
                <button onclick="clearData()" class="btn-danger">üóëÔ∏è Limpiar</button>
                
            </div>
        </div>
        <div class="side-tab right-tab" onclick="toggleRibbon('right')">üìã</div>
    </div>

    <div id="document-area">
        <div id="paper">
            <div id="watermark">
                <img src="logo.png" alt="Logo">
            </div>
            <h1 contenteditable="true" id="main-title" class="placeholder" data-placeholder="T√çTULO DEL SERM√ìN" oninput="saveCurrentWork()"></h1>
            
            <div id="author-container">
                <span class="author-label">Realizado por:</span> 
                <span contenteditable="true" id="author-name" data-placeholder="Escriba el nombre aqu√≠..." oninput="saveCurrentWork()"></span>
            </div>

            <div id="sections-container"></div>
            
            <footer id="sermon-footer">
                <div class="footer-content">
                    <p class="verse">"Tu palabra es una l√°mpara a mis pies y una luz en mi camino."</p>
                    <p class="reference">Salmo 119:105</p>
                    <div class="brand">
                        <img src="logo.png" alt="Logo" class="mini-logo">
                        <span>Studio Edition 2025</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // --- L√ìGICA DE PERSISTENCIA ---
        let allSermons = JSON.parse(localStorage.getItem('mmm_sermon_collection')) || { "Principal": { title: "", author: "", content: "" } };
        let activeSermonId = localStorage.getItem('mmm_active_id') || "Principal";

        function toggleAuthorField() {
            const container = document.getElementById('author-container');
            const isHidden = container.style.display === 'none' || container.style.display === '';
            container.style.display = isHidden ? 'block' : 'none';
            if(isHidden) document.getElementById('author-name').focus();
            saveCurrentWork();
        }

        function handleSermonSelect(select) {
            const val = select.value;
            if (!val) return;
            if (val === "NEW_SERMON") {
                const name = prompt("Nombre del nuevo bosquejo:");
                if (name && !allSermons[name]) {
                    allSermons[name] = { title: "", author: "", content: "" };
                    activeSermonId = name;
                    saveToStorage(); loadSermon(); updateSermonList();
                }
            } else if (val === "DELETE_ACTIVE") {
                if (confirm(`¬øBorrar definitivamente "${activeSermonId}"?`)) {
                    delete allSermons[activeSermonId];
                    activeSermonId = Object.keys(allSermons)[0] || "Principal";
                    if (!allSermons["Principal"]) allSermons["Principal"] = { title: "", author: "", content: "" };
                    saveToStorage(); loadSermon(); updateSermonList();
                }
            } else {
                saveCurrentWork();
                activeSermonId = val;
                localStorage.setItem('mmm_active_id', val);
                loadSermon();
            }
        }

        function updateSermonList() {
            const selector = document.getElementById('sermon-selector');
            if(!selector) return;
            selector.innerHTML = `<option value="">üìÇ Cambiar Bosquejo</option>`;
            selector.innerHTML += `<option value="NEW_SERMON">‚ûï Crear Nuevo...</option>`;
            selector.innerHTML += `<option value="DELETE_ACTIVE">‚ùå Borrar Actual</option>`;
            selector.innerHTML += `<hr>`;
            for (let id in allSermons) {
                let opt = document.createElement('option');
                opt.value = id;
                opt.innerText = (id === activeSermonId ? "üìç " : "üìÑ ") + id;
                if (id === activeSermonId) opt.selected = true;
                selector.appendChild(opt);
            }
        }

        function loadSermon() {
            const data = allSermons[activeSermonId];
            document.getElementById('main-title').innerText = data.title || "";
            document.getElementById('author-name').innerText = data.author || "";
            document.getElementById('sections-container').innerHTML = data.content || "";
            
            if (data.author && data.author !== "") {
                document.getElementById('author-container').style.display = 'block';
            } else {
                document.getElementById('author-container').style.display = 'none';
            }
            updatePageProgress(); // Actualizar barra al cargar
            if (typeof saveData === "function") saveData();
        }

        function saveCurrentWork() {
            if(!allSermons[activeSermonId]) allSermons[activeSermonId] = {};
            allSermons[activeSermonId].title = document.getElementById('main-title').innerText;
            allSermons[activeSermonId].author = document.getElementById('author-name').innerText;
            allSermons[activeSermonId].content = document.getElementById('sections-container').innerHTML;
            saveToStorage();
            updatePageProgress(); // Actualizar barra al escribir
            if (typeof saveData === "function") saveData();
        }

        // --- BARRA DE PROGRESO ---
        function updatePageProgress() {
            const paper = document.getElementById('paper');
            const bar = document.getElementById('page-progress-bar');
            const text = document.getElementById('page-progress-text');
            if (!paper || !bar) return;
            const a4HeightPx = 1122; 
            const currentHeight = paper.scrollHeight;
            let percentage = Math.round((currentHeight / a4HeightPx) * 100);
            bar.style.width = (percentage > 100 ? 100 : percentage) + "%";
            text.innerText = `Espacio: ${percentage}%`;
            bar.style.background = percentage > 95 ? "#ef4444" : "linear-gradient(90deg, #3b82f6, #10b981)";
        }

        document.getElementById('sections-container').addEventListener('input', saveCurrentWork);
        document.getElementById('main-title').addEventListener('input', saveCurrentWork);
        document.getElementById('author-name').addEventListener('input', saveCurrentWork);

        function saveToStorage() {
            localStorage.setItem('mmm_sermon_collection', JSON.stringify(allSermons));
            localStorage.setItem('mmm_active_id', activeSermonId);
        }

        function handleStudySelect(select) {
            const val = select.value;
            if (!val) return;
            if (val === "EXPORT") exportarDatosMes();
            else if (val === "IMPORT") document.getElementById('inputImport').click();
            else if (val.includes('http')) window.open(val, '_blank');
            else window.location.href = val;
            select.value = "";
        }

        function exportarDatosMes() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allSermons));
            const dlAnchor = document.createElement('a');
            const title = document.getElementById('main-title').innerText || "Sermones";
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `Backup_${title}_MMM.json`);
            dlAnchor.click();
        }

        function importarDatosMes(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    allSermons = JSON.parse(e.target.result);
                    activeSermonId = Object.keys(allSermons)[0];
                    saveToStorage(); loadSermon(); updateSermonList();
                    alert("Importaci√≥n exitosa.");
                } catch(err) { alert("Archivo inv√°lido."); }
            };
            reader.readAsText(file);
        }

        function showLoading(show) {
            const loader = document.getElementById('pdf-loader');
            if(loader) loader.style.display = show ? 'block' : 'none';
        }

        window.onload = () => { updateSermonList(); loadSermon(); };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Error', err));
            });
        }
    </script>
</body>
</html>
